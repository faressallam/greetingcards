<?php
$page_title = 'ุฅุฏุงุฑุฉ ุงูููุงูุจ';
require_once '../includes/header.php';

require_admin();

$success = '';
$error = '';

// Handle template upload
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action']) && $_POST['action'] === 'add') {
    $title = sanitize_input($_POST['title'] ?? '');
    $category_id = (int) ($_POST['category_id'] ?? 0);

    // Position fields
    $name_x = (int) ($_POST['name_x'] ?? 400);
    $stmt->execute([':id' => $id]);
    $template = $stmt->fetch();

    if ($template) {
        // Delete file
        $file_path = TEMPLATE_PATH . $template['image_path'];
        if (file_exists($file_path)) {
            unlink($file_path);
        }

        // Delete from database
        $db->prepare("DELETE FROM templates WHERE id = :id")->execute([':id' => $id]);
        $success = 'ุชู ุญุฐู ุงููุงูุจ ุจูุฌุงุญ';
    }
}

// Fetch templates
$templates = $db->query("SELECT t.*, c.name_ar as category_name 
                         FROM templates t 
                         JOIN categories c ON t.category_id = c.id 
                         ORDER BY t.created_at DESC")->fetchAll();

// Fetch categories
$categories = $db->query("SELECT * FROM categories ORDER BY display_order")->fetchAll();
?>

<div class="container" style="padding: 3rem 0;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h1>ุฅุฏุงุฑุฉ ุงูููุงูุจ</h1>
        <a href="<?php echo SITE_URL; ?>/admin/" class="btn btn-secondary">โ ุงูุนูุฏุฉ ูููุญุฉ ุงูุชุญูู</a>
    </div>

    <?php if ($success): ?>
        <div style="background: #d1fae5; color: #065f46; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
            <?php echo $success; ?>
        </div>
    <?php endif; ?>

    <?php if ($error): ?>
        <div style="background: #fee2e2; color: #991b1b; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
            <?php echo $error; ?>
        </div>
    <?php endif; ?>

    <!-- Add Template Form -->
    <div
        style="background: white; padding: 2rem; border-radius: 12px; margin-bottom: 3rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h2 style="margin-bottom: 1.5rem;">ุฅุถุงูุฉ ูุงูุจ ุฌุฏูุฏ</h2>
        <form method="POST" action="" enctype="multipart/form-data">
            <input type="hidden" name="action" value="add">

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                <div class="form-group">
                    <label class="form-label">ุนููุงู ุงููุงูุจ</label>
                    <input type="text" name="title" class="form-control" required>
                </div>

                <div class="form-group">
                    <label class="form-label">ุงููุณู</label>
                    <select name="category_id" class="form-control" required>
                        <option value="">ุงุฎุชุฑ ุงููุณู</option>
                        <?php foreach ($categories as $cat): ?>
                            <option value="<?php echo $cat['id']; ?>"><?php echo htmlspecialchars($cat['name_ar']); ?>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">X</label>
                        <input type="number" name="name_x" class="form-control" value="400">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Y</label>
                        <input type="number" name="name_y" class="form-control" value="300">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ุงูุญุฌู</label>
                        <input type="number" name="name_size" class="form-control" value="40">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ุงูููู</label>
                        <input type="color" name="name_color" class="form-control" value="#000000">
                    </div>
                </div>
            </div>

            <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 1rem;">๐ ููุถุน ุงูุฅูููุฌู</h4>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">X</label>
                        <input type="number" name="emoji_x" class="form-control" value="200">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Y</label>
                        <input type="number" name="emoji_y" class="form-control" value="150">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ุงูุญุฌู</label>
                        <input type="number" name="emoji_size" class="form-control" value="60">
                    </div>
                </div>
            </div>

            <div style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 1rem;">๐ท ููุถุน ุงูุตูุฑุฉ ุงูุดุฎุตูุฉ</h4>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">X</label>
                        <input type="number" name="photo_x" class="form-control" value="600">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Y</label>
                        <input type="number" name="photo_y" class="form-control" value="150">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ุงูุญุฌู (ูุทุฑ ุงูุฏุงุฆุฑุฉ)</label>
                        <input type="number" name="photo_size" class="form-control" value="100">
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary" style="padding: 1rem 2rem; font-size: 1.125rem;">ุฅุถุงูุฉ
                ุงููุงูุจ</button>
        </form>
    </div>

    <!-- Templates List -->
    <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h2 style="margin-bottom: 1.5rem;">ุงูููุงูุจ ุงูููุฌูุฏุฉ (<?php echo count($templates); ?>)</h2>

        <?php if (!empty($templates)): ?>
            <div class="templates-grid">
                <?php foreach ($templates as $template): ?>
                    <div class="template-card">
                        <img src="<?php echo SITE_URL . '/uploads/templates/' . $template['image_path']; ?>"
                            alt="<?php echo htmlspecialchars($template['title']); ?>" class="template-image">
                        <div class="template-info">
                            <h3 class="template-title"><?php echo htmlspecialchars($template['title']); ?></h3>
                            <p class="template-category"><?php echo htmlspecialchars($template['category_name']); ?></p>
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem; font-size: 0.875rem; color: var(--gray);">
                                <span>๐๏ธ <?php echo $template['views']; ?></span>
                                <span>โฌ๏ธ <?php echo $template['downloads']; ?></span>
                            </div>
                            <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                                <a href="<?php echo SITE_URL; ?>/editor-simple.php?template=<?php echo $template['id']; ?>"
                                    class="btn btn-primary" style="flex: 1; padding: 0.5rem; font-size: 0.875rem;">
                                    โจ ูุญุฑุฑ ุจุณูุท
                                </a>
                                <a href="<?php echo SITE_URL; ?>/editor.php?template=<?php echo $template['id']; ?>"
                                    class="btn btn-secondary" style="flex: 1; padding: 0.5rem; font-size: 0.875rem;">
                                    ๐จ ูุญุฑุฑ ูุชูุฏู
                                </a>
                            </div>
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                <a href="<?php echo SITE_URL; ?>/admin/edit-template.php?id=<?php echo $template['id']; ?>"
                                    class="btn btn-secondary" style="flex: 1; padding: 0.5rem; font-size: 0.875rem;">
                                    โ๏ธ ุชุนุฏูู
                                </a>
                                <a href="?delete=<?php echo $template['id']; ?>" class="btn btn-danger"
                                    style="flex: 1; padding: 0.5rem; font-size: 0.875rem;"
                                    onclick="return confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงููุงูุจุ')">
                                    ๐๏ธ ุญุฐู
                                </a>
                            </div>
                        </div>
                    </div>
                <?php endforeach; ?>
            </div>
        <?php else: ?>
            <p style="text-align: center; color: var(--gray); padding: 2rem;">ูุง ุชูุฌุฏ ููุงูุจ ุจุนุฏ</p>
        <?php endif; ?>
    </div>
</div>

<?php require_once '../includes/footer.php'; ?>