<?php
$page_title = 'ÿßŸÑŸÖÿ≠ÿ±ÿ± ÿßŸÑÿ®ÿ≥Ÿäÿ∑';
require_once 'includes/header.php';

// Get template ID
$template_id = isset($_GET['template']) ? (int) $_GET['template'] : 0;

// Fetch template data
$template = null;
if ($template_id) {
    $stmt = $db->prepare("SELECT t.*, c.name_ar as category_name 
                          FROM templates t 
                          JOIN categories c ON t.category_id = c.id 
                          WHERE t.id = :id AND t.is_active = 1");
    $stmt->execute([':id' => $template_id]);
    $template = $stmt->fetch();

    if ($template) {
        // Increment views
        $db->prepare("UPDATE templates SET views = views + 1 WHERE id = :id")->execute([':id' => $template_id]);
    }
    'Tajawal' => 'ÿ™ÿ¨ŸàÿßŸÑ',
    'Almarai' => 'ÿßŸÑŸÖÿ±ÿßÿπŸä',
    'El Messiri' => 'ÿßŸÑŸÖÿ≥Ÿäÿ±Ÿä',
    'Changa' => 'ÿ™ÿ¥ÿßŸÜÿ¨ÿß',
    'Lalezar' => 'ŸÑÿßŸÑŸäÿ≤ÿßÿ±',
    'Reem Kufi' => 'ÿ±ŸäŸÖ ŸÉŸàŸÅŸä',
    'Amiri' => 'ÿ£ŸÖŸäÿ±Ÿä',
    'Lateef' => 'ŸÑÿ∑ŸäŸÅ',
    'Scheherazade New' => 'ÿ¥Ÿáÿ±ÿ≤ÿßÿØ'
];

// Colors list
$colors = [
    '#000000' => 'ÿ£ÿ≥ŸàÿØ',
    '#ffffff' => 'ÿ£ÿ®Ÿäÿ∂',
    '#1f2937' => 'ÿ±ŸÖÿßÿØŸä ÿØÿßŸÉŸÜ',
    '#dc2626' => 'ÿ£ÿ≠ŸÖÿ±',
    '#2563eb' => 'ÿ£ÿ≤ÿ±ŸÇ',
    '#16a34a' => 'ÿ£ÿÆÿ∂ÿ±',
    '#d97706' => 'ÿ∞Ÿáÿ®Ÿä',
    '#7c3aed' => 'ÿ®ŸÜŸÅÿ≥ÿ¨Ÿä',
    '#db2777' => 'Ÿàÿ±ÿØŸä',
    '#0891b2' => 'ÿ≥ŸÖÿßŸàŸä'
];

// Gradients (CSS representation for UI, handled in JS for Fabric)
$gradients = [
    'linear-gradient(to right, #fcd34d, #d97706)' => 'ÿ∞Ÿáÿ®Ÿä ŸÑÿßŸÖÿπ',
    'linear-gradient(to right, #667eea, #764ba2)' => 'ÿ®ŸÜŸÅÿ≥ÿ¨Ÿä ÿ£ÿ≤ÿ±ŸÇ',
    'linear-gradient(to right, #ff9a9e, #fecfef)' => 'Ÿàÿ±ÿØŸä ŸÜÿßÿπŸÖ',
    'linear-gradient(to right, #a18cd1, #fbc2eb)' => 'ÿ≠ŸÑŸÖ ÿ®ŸÜŸÅÿ≥ÿ¨Ÿä',
    'linear-gradient(to right, #84fab0, #8fd3f4)' => 'ÿ£ÿ≤ÿ±ŸÇ ŸÖÿ≠Ÿäÿ∑Ÿä',
    'linear-gradient(to right, #ff9a9e, #fad0c4)' => 'ÿÆŸàÿÆŸä',
    'linear-gradient(to right, #fbc2eb, #a6c1ee)' => 'ÿ≥ŸÖÿßÿ° ŸáÿßÿØÿ¶ÿ©',
    'linear-gradient(to right, #ffecd2, #fcb69f)' => 'ÿ∫ÿ±Ÿàÿ® ÿßŸÑÿ¥ŸÖÿ≥',
    'linear-gradient(to right, #ff9a9e, #fecfef)' => 'ÿ≠ŸÑŸàŸâ ÿßŸÑŸÇÿ∑ŸÜ',
    'linear-gradient(to right, #a1c4fd, #c2e9fb)' => 'ÿ∫ŸäŸàŸÖ ÿ≤ÿ±ŸÇÿßÿ°'
];
?>

<!-- Add Google Fonts -->
<link
    href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700&family=Amiri:wght@400;700&family=Cairo:wght@400;700&family=Changa:wght@400;700&family=El+Messiri:wght@400;700&family=Lalezar&family=Lateef&family=Reem+Kufi:wght@400;700&family=Scheherazade+New:wght@400;700&family=Tajawal:wght@400;700&display=swap"
    rel="stylesheet">

<style>
    .simple-editor-container {
        max-width: 1000px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    .editor-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .editor-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        text-align: center;
    }

    .editor-body {
        padding: 2rem;
    }

    .canvas-preview {
        background: #f1f5f9;
        border-radius: 12px;
        padding: 2rem;
        display: flex;
        justify-content: center;
        gap: 1.5rem;
    }

    .controls-section {
        background: #f8fafc;
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
    }

    .control-label {
        font-weight: 600;
        margin-bottom: 0.75rem;
        display: block;
        color: #1e293b;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-family: 'Cairo', sans-serif;
        font-size: 1rem;
        transition: border-color 0.3s;
    }

    .form-control:focus {
        outline: none;
        border-color: #667eea;
    }

    .emoji-category-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        flex-wrap: wrap;
    }

    .emoji-category-tab {
        padding: 0.5rem 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        background: white;
        cursor: pointer;
        font-size: 0.875rem;
        transition: all 0.2s;
    }

    .emoji-category-tab:hover {
        border-color: #667eea;
        background: #f0f4ff;
    }

    .emoji-category-tab.active {
        border-color: #667eea;
        background: #667eea;
        color: white;
    }

    .emoji-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
        gap: 0.5rem;
        max-height: 150px;
        overflow-y: auto;
        padding: 0.5rem;
        background: white;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }

    .emoji-grid.hidden {
        display: none;
    }

    .emoji-btn {
        padding: 0.5rem;
        font-size: 1.25rem;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
    }

    .emoji-btn:hover {
        transform: scale(1.1);
        border-color: #667eea;
    }

    .emoji-btn.selected {
        border-color: #667eea;
        background: #f0f4ff;
    }

    .emoji-btn img {
        width: 100%;
        height: auto;
        display: block;
    }

    .color-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(30px, 1fr));
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .color-btn {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: 2px solid #e2e8f0;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .color-btn:hover {
        transform: scale(1.1);
    }

    .color-btn.selected {
        border-color: #667eea;
        box-shadow: 0 0 0 2px white, 0 0 0 4px #667eea;
    }

    .photo-upload {
        border: 2px dashed #cbd5e1;
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: white;
    }

    .photo-upload:hover {
        border-color: #667eea;
        background: #f0f4ff;
    }

    .photo-preview {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        margin: 1rem auto;
        display: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .photo-preview.show {
        display: block;
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }

    .btn-large {
        flex: 1;
        padding: 1rem 2rem;
        font-size: 1.125rem;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        font-family: 'Cairo', sans-serif;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-download {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-download:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .btn-advanced {
        background: #64748b;
        color: white;
    }

    .btn-advanced:hover {
        background: #475569;
    }

    .checkbox-wrapper {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 1rem;
        cursor: pointer;
    }

    @media (max-width: 768px) {
        .action-buttons {
            flex-direction: column;
        }

        .controls-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="simple-editor-container">
    <div class="editor-card">
        <div class="editor-header">
            <h1 style="font-size: 2rem; margin-bottom: 0.5rem;">‚ú® ÿµŸÖŸÖ ŸÉÿ±ÿ™ŸÉ ÿ®ÿ≥ŸáŸàŸÑÿ©</h1>
            <p style="opacity: 0.9;"><?php echo htmlspecialchars($template['title']); ?></p>
        </div>

        <div class="editor-body">
            <!-- Canvas Preview -->
            <div class="canvas-preview">
                <canvas id="canvas"></canvas>
            </div>

            <div class="controls-grid">
                <!-- Text Controls -->
                <div class="controls-section">
                    <label class="control-label">üìù ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÜÿµ</label>

                    <div style="margin-bottom: 1rem;">
                        <label style="font-size: 0.9rem; margin-bottom: 0.25rem; display: block;">ÿßŸÑÿßÿ≥ŸÖ</label>
                        <input type="text" id="name-input" class="form-control" placeholder="ÿßŸÉÿ™ÿ® ÿßÿ≥ŸÖŸÉ ŸáŸÜÿß"
                            maxlength="50">
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="font-size: 0.9rem; margin-bottom: 0.25rem; display: block;">ŸÜŸàÿπ ÿßŸÑÿÆÿ∑</label>
                        <select id="font-select" class="form-control">
                            <?php foreach ($fonts as $key => $name): ?>
                                <option value="<?php echo $key; ?>" style="font-family: '<?php echo $key; ?>'">
                                    <?php echo $name; ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="font-size: 0.9rem; margin-bottom: 0.25rem; display: block;">ŸÑŸàŸÜ ÿßŸÑŸÜÿµ</label>
                        <div class="color-grid" id="solid-colors">
                            <?php foreach ($colors as $hex => $name): ?>
                                <div class="color-btn" style="background-color: <?php echo $hex; ?>"
                                    data-color="<?php echo $hex; ?>" title="<?php echo $name; ?>"></div>
                            <?php endforeach; ?>
                        </div>
                        <label style="font-size: 0.9rem; margin-bottom: 0.25rem; display: block;">ÿ™ÿØÿ±ÿ¨ÿßÿ™ ŸÑŸàŸÜŸäÿ©</label>
                        <div class="color-grid" id="gradient-colors">
                            <?php foreach ($gradients as $css => $name): ?>
                                <div class="color-btn" style="background: <?php echo $css; ?>"
                                    data-gradient="<?php echo $css; ?>" title="<?php echo $name; ?>"></div>
                            <?php endforeach; ?>
                        </div>
                    </div>

                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="shadow-check" checked>
                        <span>ÿ•ÿ∂ÿßŸÅÿ© ÿ∏ŸÑ ŸÑŸÑŸÜÿµ</span>
                    </label>
                </div>

                <!-- Decoration Controls -->
                <div class="controls-section">
                    <label class="control-label">üé® ÿ•ÿ∂ÿßŸÅÿßÿ™ Ÿàÿ™ÿ≤ŸäŸäŸÜ</label>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="font-size: 0.9rem; margin-bottom: 0.25rem; display: block;">ÿßÿÆÿ™ÿ± ÿ•ŸäŸÖŸàÿ¨Ÿä</label>

                        <?php if (!empty($emojis_by_category)): ?>
                            <!-- Category Tabs -->
                            <div class="emoji-category-tabs">
                                <?php $first = true;
                                foreach ($emojis_by_category as $cat_id => $cat_data): ?>
                                    <button class="emoji-category-tab <?php echo $first ? 'active' : ''; ?>"
                                        data-category="<?php echo $cat_id; ?>">
                                        <?php echo htmlspecialchars($cat_data['name']); ?>
                                    </button>
                                    <?php $first = false; ?>
                                <?php endforeach; ?>
                            </div>

                            <!-- Emoji Grids by Category -->
                            <?php $first = true;
                            foreach ($emojis_by_category as $cat_id => $cat_data): ?>
                                <div class="emoji-grid <?php echo !$first ? 'hidden' : ''; ?>"
                                    data-category-grid="<?php echo $cat_id; ?>">
                                    <?php foreach ($cat_data['emojis'] as $emoji): ?>
                                        <button class="emoji-btn"
                                            data-emoji-url="<?php echo SITE_URL . '/uploads/emojis/' . $emoji['file_path']; ?>">
                                            <img src="<?php echo SITE_URL . '/uploads/emojis/' . $emoji['file_path']; ?>"
                                                alt="Emoji">
                                        </button>
                                    <?php endforeach; ?>
                                </div>
                                <?php $first = false; ?>
                            <?php endforeach; ?>
                        <?php else: ?>
                            <p style="color: #64748b; font-size: 0.875rem; padding: 1rem; text-align: center;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ
                                ÿ•ŸäŸÖŸàÿ¨Ÿä ŸÖÿ™ÿßÿ≠ÿ© ÿ≠ÿßŸÑŸäÿßŸã</p>
                        <?php endif; ?>
                    </div>

                    <div>
                        <label style="font-size: 0.9rem; margin-bottom: 0.25rem; display: block;">ÿµŸàÿ±ÿ© ÿ¥ÿÆÿµŸäÿ©</label>
                        <div class="photo-upload" onclick="document.getElementById('photo-input').click()">
                            <img id="photo-preview" class="photo-preview" alt="ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿµŸàÿ±ÿ©">
                            <div id="upload-text">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üì∏</div>
                                <p style="color: #64748b; font-size: 0.9rem;">ÿßÿ∂ÿ∫ÿ∑ ŸÑÿ±ŸÅÿπ ÿµŸàÿ±ÿ™ŸÉ</p>
                            </div>
                            <input type="file" id="photo-input" accept="image/*" style="display: none;">
                        </div>

                        <!-- Photo Border Controls -->
                        <div style="margin-top: 1rem; border-top: 1px solid #e2e8f0; padding-top: 1rem;">
                            <label style="font-size: 0.9rem; margin-bottom: 0.25rem; display: block;">ÿ≠ÿØŸàÿØ
                                ÿßŸÑÿµŸàÿ±ÿ©</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="range" id="border-width" min="0" max="20" value="2" style="flex: 1;">
                                <span id="border-val">2px</span>
                            </div>
                            <div style="margin-top: 0.5rem;">
                                <input type="color" id="border-color" value="#000000"
                                    style="width: 100%; height: 30px; border: none; cursor: pointer; border-radius: 6px;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button id="download-btn" class="btn-large btn-download">
                    ‚¨áÔ∏è ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿµŸÖŸäŸÖ
                </button>
                <a href="<?php echo SITE_URL; ?>/editor.php?template=<?php echo $template_id; ?>"
                    class="btn-large btn-advanced"
                    style="text-align: center; text-decoration: none; display: flex; align-items: center; justify-content: center;">
                    üé® ÿßŸÑŸÖÿ≠ÿ±ÿ± ÿßŸÑŸÖÿ™ŸÇÿØŸÖ
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    // Template data from PHP
    const TEMPLATE_DATA = <?php echo json_encode([
        'id' => $template['id'],
        'image_path' => SITE_URL . '/uploads/templates/' . $template['image_path'],
        'name_x' => $template['name_x'] ?? 400,
        'name_y' => $template['name_y'] ?? 300,
        'name_size' => $template['name_size'] ?? 40,
        'name_color' => $template['name_color'] ?? '#000000',
        'name_font' => $template['name_font'] ?? 'Cairo',
        'emoji_x' => $template['emoji_x'] ?? 200,
        'emoji_y' => $template['emoji_y'] ?? 150,
        'emoji_size' => $template['emoji_size'] ?? 60,
        'photo_x' => $template['photo_x'] ?? 600,
        'photo_y' => $template['photo_y'] ?? 150,
        'photo_size' => $template['photo_size'] ?? 100
    ]); ?>;

    const SITE_URL = '<?php echo SITE_URL; ?>';

    let canvas;
    let nameText = null;
    let emojiImage = null;
    let photoGroup = null;

    // Default settings
    let currentSettings = {
        text: '',
        font: TEMPLATE_DATA.name_font,
        color: TEMPLATE_DATA.name_color,
        gradient: null,
        shadow: true,
        emojiUrl: '',
        photo: null,
        borderWidth: 2,
        borderColor: '#000000'
    };

    // Delete Icon
    const deleteIcon = "data:image/svg+xml,%3C%3Fxml version='1.0' encoding='utf-8'%3F%3E%3C!DOCTYPE svg PUBLIC '-//W3C//DTD SVG 1.1//EN' 'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'%3E%3Csvg version='1.1' id='Ebene_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' width='595.275px' height='595.275px' viewBox='200 215 230 470' xml:space='preserve'%3E%3Ccircle style='fill:%23F44336;' cx='299.76' cy='435.375' r='217.169'/%3E%3Cg%3E%3Crect x='267.162' y='307.978' transform='matrix(0.7071 -0.7071 0.7071 0.7071 -222.6202 340.6915)' style='fill:white;' width='65.545' height='262.18'/%3E%3Crect x='266.988' y='308.153' transform='matrix(0.7071 0.7071 -0.7071 0.7071 398.3889 -83.3116)' style='fill:white;' width='65.544' height='262.179'/%3E%3C/g%3E%3C/svg%3E";

    const deleteImg = document.createElement('img');
    deleteImg.src = deleteIcon;

    // Initialize canvas
    document.addEventListener('DOMContentLoaded', function () {
        initializeCanvas();
    });

    function initializeCanvas() {
        const tempImg = new Image();
        tempImg.crossOrigin = 'anonymous';

        tempImg.onload = function () {
            canvas = new fabric.Canvas('canvas', {
                width: tempImg.width,
                height: tempImg.height,
                backgroundColor: '#ffffff',
                selection: true
            });

            // Customize controls
            fabric.Object.prototype.set({
                transparentCorners: false,
                cornerColor: '#667eea',
                cornerStrokeColor: '#ffffff',
                borderColor: '#667eea',
                cornerSize: 15,
                padding: 0,
                cornerStyle: 'circle'
            });

            // Add custom delete control
            fabric.Object.prototype.controls.deleteControl = new fabric.Control({
                x: 0.5,
                y: -0.5,
                offsetY: -16,
                offsetX: 16,
                cursorStyle: 'pointer',
                mouseUpHandler: deleteObject,
                render: renderIcon,
                cornerSize: 24
            });

            loadTemplateImage();
            setupEventListeners();

            document.getElementById('font-select').value = TEMPLATE_DATA.name_font;
            document.getElementById('shadow-check').checked = true;
        };

        tempImg.onerror = function () {
            console.error('Failed to load template image');
            alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿµŸàÿ±ÿ© ÿßŸÑŸÇÿßŸÑÿ®. Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸÅÿ≠ÿ©.');
        };

        tempImg.src = TEMPLATE_DATA.image_path;
    }

    function deleteObject(eventData, transform) {
        var target = transform.target;
        var canvas = target.canvas;

        if (target === nameText) {
            nameText = null;
            document.getElementById('name-input').value = '';
        } else if (target === emojiImage) {
            emojiImage = null;
            document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('selected'));
        } else if (target === photoGroup) {
            photoGroup = null;
            document.getElementById('photo-preview').classList.remove('show');
            document.getElementById('upload-text').style.display = 'block';
            document.getElementById('photo-input').value = '';
        }

        canvas.remove(target);
        canvas.requestRenderAll();
    }

    function renderIcon(ctx, left, top, styleOverride, fabricObject) {
        var size = this.cornerSize;
        ctx.save();
        ctx.translate(left, top);
        ctx.rotate(fabric.util.degreesToRadians(fabricObject.angle));
        ctx.drawImage(deleteImg, -size / 2, -size / 2, size, size);
        ctx.restore();
    }

    function loadTemplateImage() {
        fabric.Image.fromURL(TEMPLATE_DATA.image_path, function (img) {
            img.set({
                left: 0,
                top: 0,
                selectable: false,
                evented: false
            });
            canvas.add(img);
            canvas.sendToBack(img);
            canvas.renderAll();
        }, { crossOrigin: 'anonymous' });
    }

    function setupEventListeners() {
        // Name input
        document.getElementById('name-input').addEventListener('input', function (e) {
            currentSettings.text = e.target.value;
            updateName();
        });

        // Font select
        document.getElementById('font-select').addEventListener('change', function (e) {
            currentSettings.font = e.target.value;
            updateName();
        });

        // Color buttons
        document.querySelectorAll('.color-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');

                if (this.dataset.color) {
                    currentSettings.color = this.dataset.color;
                    currentSettings.gradient = null;
                } else if (this.dataset.gradient) {
                    currentSettings.gradient = this.dataset.gradient;
                }
                updateName();
            });
        });

        // Shadow checkbox
        document.getElementById('shadow-check').addEventListener('change', function (e) {
            currentSettings.shadow = e.target.checked;
            updateName();
            updatePhoto();
        });

        // Emoji category tabs
        document.querySelectorAll('.emoji-category-tab').forEach(tab => {
            tab.addEventListener('click', function () {
                const categoryId = this.dataset.category;

                // Update active tab
                document.querySelectorAll('.emoji-category-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                // Show corresponding emoji grid
                document.querySelectorAll('.emoji-grid').forEach(grid => grid.classList.add('hidden'));
                document.querySelector(`[data-category-grid="${categoryId}"]`).classList.remove('hidden');
            });
        });

        // Emoji buttons
        document.querySelectorAll('.emoji-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                currentSettings.emojiUrl = this.dataset.emojiUrl;
                updateEmoji();
            });
        });

        // Photo upload
        document.getElementById('photo-input').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    currentSettings.photo = event.target.result;

                    const preview = document.getElementById('photo-preview');
                    preview.src = currentSettings.photo;
                    preview.classList.add('show');
                    document.getElementById('upload-text').style.display = 'none';

                    updatePhoto();
                };
                reader.readAsDataURL(file);
            }
        });

        // Photo Border Controls
        document.getElementById('border-width').addEventListener('input', function (e) {
            currentSettings.borderWidth = parseInt(e.target.value);
            document.getElementById('border-val').innerText = currentSettings.borderWidth + 'px';
            updatePhoto();
        });

        document.getElementById('border-color').addEventListener('input', function (e) {
            currentSettings.borderColor = e.target.value;
            updatePhoto();
        });

        // Download button
        document.getElementById('download-btn').addEventListener('click', downloadCanvas);
    }

    function updateName() {
        if (currentSettings.text.trim()) {
            if (!nameText) {
                nameText = new fabric.Text(currentSettings.text, {
                    left: TEMPLATE_DATA.name_x,
                    top: TEMPLATE_DATA.name_y,
                    fontSize: TEMPLATE_DATA.name_size,
                    fontFamily: currentSettings.font,
                    fontWeight: 'bold',
                    fill: currentSettings.color,
                    originX: 'center',
                    originY: 'center',
                    selectable: true
                });
                canvas.add(nameText);
            } else {
                nameText.set({
                    text: currentSettings.text,
                    fontFamily: currentSettings.font
                });
            }

            if (currentSettings.gradient) {
                const matches = currentSettings.gradient.match(/#[a-fA-F0-9]{6}/g);
                if (matches && matches.length >= 2) {
                    const gradient = new fabric.Gradient({
                        type: 'linear',
                        gradientUnits: 'percentage',
                        coords: { x1: 0, y1: 0, x2: 1, y2: 0 },
                        colorStops: [
                            { offset: 0, color: matches[0] },
                            { offset: 1, color: matches[1] }
                        ]
                    });
                    nameText.set('fill', gradient);
                }
            } else {
                nameText.set('fill', currentSettings.color);
            }

            if (currentSettings.shadow) {
                nameText.set('shadow', new fabric.Shadow({
                    color: 'rgba(0,0,0,0.3)',
                    blur: 5,
                    offsetX: 2,
                    offsetY: 2
                }));
            } else {
                nameText.set('shadow', null);
            }

            canvas.setActiveObject(nameText);
            canvas.renderAll();
        } else if (nameText) {
            canvas.remove(nameText);
            nameText = null;
            canvas.renderAll();
        }
    }

    function updateEmoji() {
        if (currentSettings.emojiUrl) {
            let prevLeft = TEMPLATE_DATA.emoji_x;
            let prevTop = TEMPLATE_DATA.emoji_y;
            let prevScale = 1;

            if (emojiImage) {
                prevLeft = emojiImage.left;
                prevTop = emojiImage.top;
                prevScale = emojiImage.scaleX;
                canvas.remove(emojiImage);
            }

            fabric.Image.fromURL(currentSettings.emojiUrl, function (img) {
                let scale = prevScale;
                if (!emojiImage) {
                    scale = TEMPLATE_DATA.emoji_size / Math.max(img.width, img.height);
                }

                emojiImage = img;
                emojiImage.set({
                    left: prevLeft,
                    top: prevTop,
                    scaleX: scale,
                    scaleY: scale,
                    originX: 'center',
                    originY: 'center',
                    selectable: true
                });

                canvas.add(emojiImage);
                canvas.renderAll();
            }, { crossOrigin: 'anonymous' });
        } else if (emojiImage) {
            canvas.remove(emojiImage);
            emojiImage = null;
            canvas.renderAll();
        }
    }

    function updatePhoto() {
        if (currentSettings.photo) {
            let prevLeft = TEMPLATE_DATA.photo_x;
            let prevTop = TEMPLATE_DATA.photo_y;
            let prevScale = 1;

            if (photoGroup) {
                prevLeft = photoGroup.left;
                prevTop = photoGroup.top;
                prevScale = photoGroup.scaleX;
                canvas.remove(photoGroup);
            }

            fabric.Image.fromURL(currentSettings.photo, function (img) {
                let scale = 1;
                if (!photoGroup) {
                    scale = TEMPLATE_DATA.photo_size / Math.min(img.width, img.height);
                } else {
                    scale = prevScale;
                }

                const radius = Math.min(img.width, img.height) / 2;
                const clipPath = new fabric.Circle({
                    radius: radius,
                    originX: 'center',
                    originY: 'center',
                    left: 0,
                    top: 0
                });

                img.set({
                    originX: 'center',
                    originY: 'center',
                    clipPath: clipPath
                });

                const border = new fabric.Circle({
                    radius: radius,
                    originX: 'center',
                    originY: 'center',
                    fill: 'transparent',
                    stroke: currentSettings.borderColor,
                    strokeWidth: currentSettings.borderWidth / scale,
                    left: 0,
                    top: 0
                });

                photoGroup = new fabric.Group([img, border], {
                    left: prevLeft,
                    top: prevTop,
                    scaleX: scale,
                    scaleY: scale,
                    originX: 'center',
                    originY: 'center',
                    selectable: true
                });

                if (currentSettings.shadow) {
                    photoGroup.set('shadow', new fabric.Shadow({
                        color: 'rgba(0,0,0,0.3)',
                        blur: 10,
                        offsetX: 5,
                        offsetY: 5
                    }));
                } else {
                    photoGroup.set('shadow', null);
                }

                canvas.add(photoGroup);
                canvas.bringToFront(photoGroup);
                canvas.renderAll();
            });
        } else if (photoGroup) {
            canvas.remove(photoGroup);
            photoGroup = null;
            canvas.renderAll();
        }
    }

    function downloadCanvas() {
        canvas.discardActiveObject();
        canvas.renderAll();

        const dataURL = canvas.toDataURL({
            format: 'png',
            quality: 1,
            multiplier: 2
        });

        const link = document.createElement('a');
        link.download = 'greeting-card.png';
        link.href = dataURL;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>

<?php require_once 'includes/footer.php'; ?>